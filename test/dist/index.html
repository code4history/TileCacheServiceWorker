<html>
<body>
aaaabbbb
</body>
<script>
    async function run() {
        window.addEventListener('service-worker-ready', async (e) => {
            try {
                const pong = await fetch('https://weiwu.example.com/api/ping');
                if (pong) {
                    const res = await fetch('https://weiwu.example.com/api/add?mapID=piyo&type=xyz&width=255&height=1024&url=http://hoge.com/hoge/hoge');
                    res.text().then(txt => console.log(txt));
                    const res2 = await fetch('https://weiwu.example.com/api/add?mapID=hoge&type=wmts&minLat=35.0&maxLat=35.1&minLng=135.0&maxLng=135.1&minZoom=17&maxZoom=18&url=https://b.tile.openstreetmap.org/{z}/{x}/{y}.png');
                    res2.text().then(txt => console.log(txt));
                    const res3 = await fetch('https://weiwu.example.com/api/add?mapID=fuga&type=wmts&minZoom=17&maxZoom=18&url=http://hoge.com/hoge/hoge');
                    res3.text().then(txt => console.log(txt));
                    const res4 = await fetch('https://weiwu.example.com/api/delete?mapID=fuga');
                    res4.text().then(txt => console.log(txt));
                    //const res5 = await fetch('https://weiwu.example.com/api/clean?mapID=hoge');
                    //res5.text().then(txt => console.log(txt));
                    document.querySelector('body').insertAdjacentHTML('beforeend', '<img src="https://weiwu.example.com/api/cache/hoge/18/229448/103745">');
                    const res6 = await fetch('https://weiwu.example.com/api/fetchAll?mapID=hoge');
                    res6.text().then(txt => console.log(txt));
                    const res7 = await fetch('https://weiwu.example.com/api/stats?mapID=hoge');
                    res7.text().then(txt => console.log(txt));
                }
            } catch (err) {
                console.log(err);
            }
        });

        if ('serviceWorker' in navigator) {
            try {
                const reg = await navigator.serviceWorker.register('./sw.js', {scope: './'});
                navigator.serviceWorker.addEventListener('message', (e) => {
                    console.log('Event');
                    console.log(e);
                })
                console.log('Registration succeeded. Scope is ' + reg.scope);

                if (navigator.serviceWorker.controller) {
                    // let the application know our service worker is ready
                    window['serviceWorkerReady'] = true;
                    window.dispatchEvent(new CustomEvent('service-worker-ready'));
                }

                // A wild service worker has appeared in reg.installing and maybe in waiting!
                const newWorker = reg.installing;
                const waitingWoker = reg.waiting;

                if (newWorker) {
                    if (newWorker.state === 'activated' && !waitingWoker) {
                        // reload to avoid skipWaiting and clients.claim()
                        window.location.reload();
                    }
                    newWorker.addEventListener('statechange', (e) => {
                        // newWorker.state has changed
                        if (newWorker.state === 'activated' && !waitingWoker) {
                            // reload to avoid skipWaiting and clients.claim()
                            window.location.reload();
                        }
                    });
                }
            } catch(err) {
                // registration failed
                console.log('Registration failed with ' + err);
            }
        }
    }
    run();
</script>
</html>